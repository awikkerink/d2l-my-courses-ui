<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../iron-scroll-threshold/iron-scroll-threshold.html">
<link rel="import" href="../../d2l-dropdown/d2l-dropdown.html">
<link rel="import" href="../../d2l-dropdown/d2l-dropdown-content.html">
<link rel="import" href="../../d2l-dropdown/d2l-dropdown-menu.html">
<link rel="import" href="../../d2l-hm-constants-behavior/d2l-hm-constants-behavior.html">
<link rel="import" href="../../d2l-icons/d2l-icons.html">
<link rel="import" href="../../d2l-loading-spinner/d2l-loading-spinner.html">
<link rel="import" href="../../d2l-menu/d2l-menu-item-radio.html">
<link rel="import" href="../../d2l-organization-hm-behavior/d2l-organization-hm-behavior.html">
<link rel="import" href="../../d2l-simple-overlay/d2l-simple-overlay.html">
<link rel="import" href="d2l-all-courses-styles.html">
<link rel="import" href="d2l-course-management-behavior.html">
<link rel="import" href="d2l-course-tile-grid.html">
<link rel="import" href="d2l-course-tile-responsive-grid-behavior.html">
<link rel="import" href="d2l-filter-menu/d2l-filter-menu.html">
<link rel="import" href="d2l-search-widget-custom.html">
<link rel="import" href="d2l-utility-behavior.html">
<link rel="import" href="localize-behavior.html">
<link rel="import" href="d2l-all-courses-segregated-content.html">
<link rel="import" href="d2l-all-courses-unified-content.html">

<dom-module id="d2l-all-courses">
	<template>
		<style include="d2l-all-courses-styles"></style>

		<d2l-simple-overlay
			id="all-courses"
			title-name="{{localize('allCourses')}}"
			close-simple-overlay-alt-text="{{localize('closeSimpleOverlayAltText')}}"
			with-backdrop
			restore-focus-on-close>

			<div hidden$="[[!_showContent]]">
				<iron-scroll-threshold
					id="all-courses-scroll-threshold"
					on-lower-threshold="_onAllCoursesLowerThreshold">
				</iron-scroll-threshold>

				<div id="search-and-filter">
					<div class="search-and-filter-row">
						<d2l-search-widget-custom
							id="search-widget"
							search-button-label="{{localize('search')}}"
							clear-button-label="{{localize('search.clearSearch')}}"
							search-action="[[_enrollmentsSearchAction]]"
							search-url="[[_searchUrl]]">
						</d2l-search-widget-custom>

						<div id="filterAndSort">
							<d2l-dropdown id="filterDropdown">
								<button
									class="d2l-dropdown-opener dropdown-button"
									aria-labelledby="filterText">
									<span id="filterText" class="dropdown-opener-text">[[_filterText]]</span>
									<d2l-icon icon="d2l-tier1:chevron-down" aria-hidden="true"></d2l-icon>
								</button>
								<d2l-dropdown-content id="filterDropdownContent" no-padding min-width="350" render-content>
									<d2l-filter-menu
										id="filterMenu"
										my-enrollments-entity="[[myEnrollmentsEntity]]",
										filter-standard-semester-name="[[filterStandardSemesterName]]",
										filter-standard-department-name="[[filterStandardDepartmentName]]">
									</d2l-filter-menu>
								</d2l-dropdown-content>
							</d2l-dropdown>

							<d2l-dropdown id="sortDropdown">
								<button
									class="d2l-dropdown-opener dropdown-button"
									aria-labelledby="sortText">
									<span id="sortText" class="dropdown-opener-text">{{localize('sorting.sortCourseName')}}</span>
									<d2l-icon icon="d2l-tier1:chevron-down" aria-hidden="true"></d2l-icon>
								</button>
								<d2l-dropdown-menu no-padding min-width="350">
									<d2l-menu id="sortDropdownMenu" label="{{localize('sorting.sortBy')}}">
										<div class="dropdown-content-header">
											<span>{{localize('sorting.sortBy')}}</span>
										</div>
										<d2l-menu-item-radio hidden$="[[!updatedSortLogic]]" class="dropdown-content-gradient" value="Default" text="{{localize('sorting.default')}}"></d2l-menu-item-radio>
										<d2l-menu-item-radio value="OrgUnitName" class$="{{_showDropdownGradient(updatedSortLogic)}}" text="{{localize('sorting.sortCourseName')}}"></d2l-menu-item-radio>
										<d2l-menu-item-radio value="OrgUnitCode" text="{{localize('sorting.sortCourseCode')}}"></d2l-menu-item-radio>
										<d2l-menu-item-radio value="PinDate" text="{{localize('sorting.sortDatePinned')}}"></d2l-menu-item-radio>
										<d2l-menu-item-radio value="LastAccessed" text="{{localize('sorting.sortLastAccessed')}}"></d2l-menu-item-radio>
										<d2l-menu-item-radio hidden$="[[!updatedSortLogic]]" value="EnrollmentDate" text="{{localize('sorting.enrollmentDate')}}"></d2l-menu-item-radio>
									</d2l-menu>
								</d2l-dropdown-menu>
							</d2l-dropdown>
						</div>
					</div>
					<div class="search-and-filter-row advanced-search-link" hidden$="[[!_showAdvancedSearchLink]]" >
						<a is="d2l-link" href$="[[advancedSearchUrl]]">{{localize('advancedSearch')}}</a>
					</div>
				</div>

				<div>
					<template is="dom-if" if="[[updatedSortLogic]]">
						<d2l-all-courses-unified-content
							show-course-code="[[showCourseCode]]"
							show-semester="[[showSemester]]"
							course-updates-config="[[courseUpdatesConfig]]"
							updated-sort-logic="[[updatedSortLogic]]"
							filter-count="[[filterCount]]"
							is-searched="[[_isSearched]]"
							filtered-enrollments="[[filteredEnrollments]]"
							enrollments="[[enrollments]]"
						></d2l-all-courses-segregated-content>
					</template>
					<template is="dom-if" if$="[[!updatedSortLogic]]">
						<d2l-all-courses-segregated-content
							show-course-code="[[showCourseCode]]"
							show-semester="[[showSemester]]"
							course-updates-config="[[courseUpdatesConfig]]"
							updated-sort-logic="[[updatedSortLogic]]"
							filter-count="[[filterCount]]"
							is-searched="[[_isSearched]]"
							filtered-pinned-enrollments="[[filteredPinnedEnrollments]]"
							filtered-unpinned-enrollments="[[filteredUnpinnedEnrollments]]"
							pinned-enrollments="[[pinnedEnrollments]]"
							unpinned-enrollments="[[unpinnedEnrollments]]"
						></d2l-all-courses-segregated-content>
					</template>
				</div>
				<d2l-loading-spinner
					id="lazyLoadSpinner"
					hidden$="[[!_hasMoreEnrollments]]"
					size="100">
				</d2l-loading-spinner>
			</div>
			<d2l-loading-spinner
				hidden$="[[_showContent]]"
				size="100">
			</d2l-loading-spinner>
		</d2l-simple-overlay>
	</template>
	<script>
		Polymer({
			is: 'd2l-all-courses',
			properties: {
				/*
				* Public Polymer properties
				*/

				// URL that directs to the advanced search page
				advancedSearchUrl: String,
				// Types of notifications to include in update count in course tile
				courseUpdatesConfig: Object,
				// Default option in Sort menu
				defaultSortValue: {
					type: String,
					value: 'OrgUnitName'
				},
				// Standard Department OU Type name to be displayed in the filter dropdown
				filterStandardDepartmentName: String,
				// Standard Semester OU Type name to be displayed in the filter dropdown
				filterStandardSemesterName: String,
				// Object containing the last response from an enrollments search request
				lastEnrollmentsSearchResponse: Object,
				// Entity returned from my-enrollments Link from the enrollments root
				myEnrollmentsEntity: {
					type: Object,
					value: function() { return {}; },
					observer: '_myEnrollmentsEntityChanged'
				},
				// Set of pinned enrollment Entities
				pinnedEnrollments: {
					type: Array,
					value: function() { return []; },
					observer: '_setFilteredPinnedEnrollments'
				},
				searchUrl: String,
				showCourseCode: Boolean,
				showSemester: Boolean,
				// Feature flag (switch) for using the updated sort logic and related fetaures
				updatedSortLogic: {
					type: Boolean,
					value: false,
					observer: '_updatedSortLogicChanged'
				},
				// Set of unpinned enrollment Entities
				unpinnedEnrollments: {
					type: Array,
					value: function() { return []; },
					observer: '_setFilteredUnpinnedEnrollments'
				},
				enrollments: {
					type: Array,
					value: function() { return []; },
					observer: '_setFilteredEnrollments'
				},

				/*
				* Private Polymer properties
				*/

				// search-my-enrollments Action
				_enrollmentsSearchAction: Object,
				// URL constructed to fetch a user's enrollments with the enrollments search Action
				_enrollmentsSearchUrl: String,
				// Filter dropdown opener text
				_filterText: String,
				// filtered pinned enrollment entities
				filteredPinnedEnrollments: {
					type: Array,
					value: function() { return []; }
				},
				filteredUnpinnedEnrollments: {
					type: Array,
					value: function() { return []; }
				},
				filteredEnrollments: {
					type: Array,
					value: function() { return []; }
				},
				// True when there are any filtered enrollments (pinned or unpinned)
				_hasFilteredEnrollments: Boolean,
				// True when there are more enrollments to fetch (i.e. current page of enrollments has a `next` link)
				_hasMoreEnrollments: {
					type: Boolean,
					computed: '_computeHasMoreEnrollments(lastEnrollmentsSearchResponse)'
				},
				// Object containing the IDs of previously loaded pinned enrollments, to avoid duplicates
				_pinnedCoursesMap: {
					type: Object,
					value: function() { return {}; }
				},
				_coursesMap: {
					type: Object,
					value: function() { return {}; }
				},
				// URL passed to search widget, called for searching
				_searchUrl: String,
				_showAdvancedSearchLink: {
					type: Boolean,
					value: false,
					computed: '_computeShowAdvancedSearchLink(advancedSearchUrl)'
				},
				_showContent: {
					type: Boolean,
					value: false
				},
				// Object containing the IDs of previously loaded unpinned enrollments, to avoid duplicates
				_unpinnedCoursesMap: {
					type: Object,
					value: function() { return {}; }
				},
				// Number of filters currently selected; used to change opener text when menu closes
				filterCount: {
					type: Number,
					value: 0
				},
				updatedSortLogicInitallyObserved: false,
				_isSearched: Boolean
			},
			behaviors: [
				window.D2L.Hypermedia.HMConstantsBehavior,
				window.D2L.Hypermedia.OrganizationHMBehavior,
				D2L.PolymerBehaviors.MyCourses.LocalizeBehavior,
				window.D2L.MyCourses.CourseManagementBehavior,
				window.D2L.MyCourses.UtilityBehavior
			],
			listeners: {
				'd2l-simple-overlay-opening': '_onSimpleOverlayOpening'
			},
			observers: [
				'_enrollmentsChanged(filteredPinnedEnrollments.length, filteredUnpinnedEnrollments.length)'
			],
			ready: function() {
				this._filterText = this.localize('filtering.filter');
			},
			attached: function() {
				this.listen(this.$.sortDropdown, 'd2l-menu-item-change', '_onSortOrderChanged');
				this.listen(this.$.filterDropdownContent, 'd2l-dropdown-open', '_onFilterDropdownOpen');
				this.listen(this.$.filterDropdownContent, 'd2l-dropdown-close', '_onFilterDropdownClose');
				this.listen(this.$.filterMenu, 'd2l-filter-menu-change', '_onFilterChanged');
				this.listen(this.$['search-widget'], 'd2l-search-widget-results-changed', '_onSearchResultsChanged');
			},
			detached: function() {
				this.unlisten(this.$.sortDropdown, 'd2l-menu-item-change', '_onSortOrderChanged');
				this.unlisten(this.$.filterDropdownContent, 'd2l-dropdown-open', '_onFilterDropdownOpen');
				this.unlisten(this.$.filterDropdownContent, 'd2l-dropdown-close', '_onFilterDropdownClose');
				this.unlisten(this.$.filterMenu, 'd2l-filter-menu-change', '_onFilterChanged');
				this.unlisten(this.$['search-widget'], 'd2l-search-widget-results-changed', '_onSearchResultsChanged');
			},

			/*
			* Public API methods
			*/

			load: function() {
				this.$['all-courses-scroll-threshold'].scrollTarget = this.$['all-courses'].scrollRegion;
				this.$['all-courses-scroll-threshold'].clearTriggers();
				if (this.updatedSortLogic) {
					this.filteredEnrollments.forEach(function(enrollment) {
						this._coursesMap[this.getEntityIdentifier(enrollment)] = true;
					}, this);
				} else {
					this.filteredPinnedEnrollments.forEach(function(enrollment) {
						this._pinnedCoursesMap[this.getEntityIdentifier(enrollment)] = true;
					}, this);
					this.filteredPinnedEnrollments.forEach(function(enrollment) {
						this._unpinnedCoursesMap[this.getEntityIdentifier(enrollment)] = true;
					}, this);
				}

				var url;
				// We never want to autopin results in the overlay
				url = this.searchUrl.replace('autoPinCourses=true', 'autoPinCourses=false');
				// Busts d2l-fetch cache, since enrollments may have been pinned/unpinned
				// since last time this URL was fetched
				url += '&bustCache=' + Math.random();
				this._searchUrl = url;

				requestAnimationFrame(function() {
					this.fire('recalculate-columns');
				}.bind(this));
			},
			open: function() {
				// Initially hide the content, until we have some data to show
				// (set back to true in _onSearchResultsChanged)
				this._showContent = false;

				this.$$('#all-courses').open();
				this.load();
			},
			setCourseImage: function(details) {
				if (this.updatedSortLogic) {
					this.$$('d2l-all-courses-unified-content').setCourseImage(details);
				} else {
					this.$$('d2l-all-courses-segregated-content').setCourseImage(details);
				}
			},

			/*
			* Listeners
			*/

			_onAllCoursesLowerThreshold: function() {
				if (this.$['all-courses'].opened && this.lastEnrollmentsSearchResponse) {
					var lastResponseEntity = this.parseEntity(this.lastEnrollmentsSearchResponse);

					if (lastResponseEntity && lastResponseEntity.hasLinkByRel('next')) {
						this._enrollmentsSearchUrl = lastResponseEntity.getLinkByRel('next').href;
						this.$.lazyLoadSpinner.scrollIntoView();

						return this.fetchSirenEntity(this._enrollmentsSearchUrl)
							.then(function(enrollmentsEntity) {
								this._updateFilteredEnrollments(enrollmentsEntity, true);
							}.bind(this));
					}
				}
			},
			_onFilterChanged: function(e) {
				this._searchUrl = e.detail.url;
				this.filterCount = e.detail.filterCount;
			},
			_onFilterDropdownClose: function() {
				var text;
				if (this.filterCount === 0) {
					text = this.localize('filtering.filter');
				} else if (this.filterCount === 1) {
					text = this.localize('filtering.filterSingle');
				} else {
					text = this.localize('filtering.filterMultiple', 'num', this.filterCount);
				}
				this.set('_filterText', text);
			},
			_onFilterDropdownOpen: function() {
				this.set('_filterText', this.localize('filtering.filter'));
				return this.$.filterMenu.open();
			},
			_onSortOrderChanged: function(e) {
				var queryParameter, langterm;
				var promotePins = false;

				switch (e.detail.value) {
					case 'OrgUnitName':
						langterm = 'sorting.sortCourseName';
						queryParameter = this.updatedSortLogic ? 'OrgUnitName,OrgUnitId' : '-PinDate,OrgUnitName,OrgUnitId';
						break;
					case 'OrgUnitCode':
						langterm = 'sorting.sortCourseCode';
						queryParameter = this.updatedSortLogic ? 'OrgUnitCode,OrgUnitId' : '-PinDate,OrgUnitCode,OrgUnitId';
						break;
					case 'PinDate':
						langterm = 'sorting.sortDatePinned';
						queryParameter = '-PinDate,OrgUnitId';
						promotePins = this.updatedSortLogic;
						break;
					case 'LastAccessed':
						langterm = 'sorting.sortLastAccessed';
						queryParameter = this.updatedSortLogic ? 'LastAccessed' : 'LastAccessed';
						break;
					case 'EnrollmentDate':
						langterm = 'sorting.enrollmentDate';
						queryParameter = 'LastModifiedDate,OrgUnitId';
						break;
					case 'Default':
						langterm = 'sorting.default';
						queryParameter = 'Current';
						promotePins = true;
						break;
					default:
						langterm = this.updatedSortLogic ? 'sorting.default' : 'sorting.sortCourseName';
						queryParameter =  this.updatedSortLogic ? 'Current' : '-PinDate,OrgUnitName,OrgUnitId';
						promotePins = this.updatedSortLogic;
						break;
				}

				this._searchUrl = this.createActionUrl(this._enrollmentsSearchAction, {
					sort: queryParameter,
					promotePins: promotePins
				});

				this.$.sortText.textContent = this.localize(langterm || '');
				this.$.sortDropdown.toggleOpen();
			},
			_onSearchResultsChanged: function(e) {
				this._isSearched = this.$['search-widget']._showClearIcon;
				if (this.updatedSortLogic) {
					this._coursesMap = {};
				} else {
					this._pinnedCoursesMap = {};
					this._unpinnedCoursesMap = {};
				}
				this._updateFilteredEnrollments(e.detail, false);
				this.myEnrollmentsEntity = e.detail;
				this._showContent = true;
			},
			_onSimpleOverlayOpening: function() {
				if (this.updatedSortLogic) {
					this.$$('d2l-all-courses-unified-content').removeSetCourseImageFailure();
				} else {
					this.$$('d2l-all-courses-segregated-content').removeSetCourseImageFailure();
				}
				this._clearSearchWidget();
				this.$.filterMenu.clearFilters();
				this._filterText = this.localize('filtering.filter');
				this._resetSortDropdown();
			},

			/*
			* Observers
			*/

			_enrollmentsChanged: function() {
				this.$['all-courses-scroll-threshold'].clearTriggers();
			},
			_myEnrollmentsEntityChanged: function(entity) {
				var myEnrollmentsEntity = this.parseEntity(entity);
				if (!myEnrollmentsEntity.hasActionByName(this.HypermediaActions.enrollments.searchMyEnrollments)) {
					return;
				}

				this._enrollmentsSearchAction = myEnrollmentsEntity.getActionByName(this.HypermediaActions.enrollments.searchMyEnrollments);
			},

			/*
			* Utility/helper functions
			*/

			_clearFilteredCourses: function() {
				if (this.updatedSortLogic) {
					this._coursesMap = {};
					this.filteredEnrollments = this.enrollments.slice();
				} else {
					this._pinnedCoursesMap = {};
					this._unpinnedCoursesMap = {};
					this.filteredPinnedEnrollments = this.pinnedEnrollments.slice();
					this.filteredUnpinnedEnrollments = this.unpinnedEnrollments.slice();
				}
			},
			_clearSearchWidget: function() {
				this.$['search-widget'].clear();
				this._clearFilteredCourses();
			},
			_computeHasMoreEnrollments: function(lastResponse) {
				lastResponse = this.parseEntity(lastResponse);
				return lastResponse.hasLinkByRel('next');
			},
			_computeShowAdvancedSearchLink: function(link) {
				return !!link;
			},
			_resetSortDropdown: function() {
				this.$.sortDropdownMenu.querySelector('d2l-menu-item-radio[value=' + this.defaultSortValue + ']').click();

				var content = this.$.sortDropdown.queryEffectiveChildren('[d2l-dropdown-content]');
				if (content) {
					content.close();
				}
			},
			_setFilteredEnrollments: function() {
				this.filteredEnrollments = this.enrollments.slice();
			},
			_setFilteredPinnedEnrollments: function() {
				this.filteredPinnedEnrollments = this.pinnedEnrollments.slice();
			},
			_setFilteredUnpinnedEnrollments: function() {
				this.filteredUnpinnedEnrollments = this.unpinnedEnrollments.slice();
			},
			_updateFilteredEnrollments: function(enrollments, append) {
				var enrollmentEntities = enrollments.getSubEntitiesByClass(this.HypermediaClasses.enrollments.enrollment);

				if (this.updatedSortLogic) {
					enrollmentEntities.forEach(function(enrollment) {
						var enrollmentId = this.getEntityIdentifier(enrollment);
						this._coursesMap[enrollmentId] = true;
					}, this);
					if (append) {
						this.filteredEnrollments = this.filteredEnrollments.concat(enrollmentEntities);
					} else {
						this.filteredEnrollments = enrollmentEntities;
					}
				} else {
					var newPinnedEnrollments = [];
					var newUnpinnedEnrollments = [];
					enrollmentEntities.forEach(function(enrollment) {
						var enrollmentId = this.getEntityIdentifier(enrollment);

						if (enrollment.hasClass(this.HypermediaClasses.enrollments.pinned)) {
							if (!this._pinnedCoursesMap.hasOwnProperty(enrollmentId)) {
								newPinnedEnrollments.push(enrollment);
								this._pinnedCoursesMap[enrollmentId] = true;
							}
						} else {
							if (!this._unpinnedCoursesMap.hasOwnProperty(enrollmentId)) {
								newUnpinnedEnrollments.push(enrollment);
								this._unpinnedCoursesMap[enrollmentId] = true;
							}
						}
					}, this);

					if (append) {
						this.filteredPinnedEnrollments = this.filteredPinnedEnrollments.concat(newPinnedEnrollments);
						this.filteredUnpinnedEnrollments = this.filteredUnpinnedEnrollments.concat(newUnpinnedEnrollments);
					} else {
						this.filteredPinnedEnrollments = newPinnedEnrollments;
						this.filteredUnpinnedEnrollments = newUnpinnedEnrollments;
					}
				}

				this.$['all-courses-scroll-threshold'].clearTriggers();
				this.lastEnrollmentsSearchResponse = enrollments;
			},
			_showDropdownGradient: function(updatedSortLogic) {
				return updatedSortLogic ? '' : 'dropdown-content-gradient';
			},
			_updatedSortLogicChanged: function(updatedSortLogic) {
				if (this.updatedSortLogicInitallyObserved) {
					this.defaultSortValue = updatedSortLogic ? 'Default' : 'OrgUnitName';
					this.$.sortDropdownMenu.querySelector('d2l-menu-item-radio[value=' + this.defaultSortValue + ']').selected = true;
					var langterm = updatedSortLogic ? 'sorting.default' : 'sorting.sortCourseName';
					this.$.sortText.textContent = this.localize(langterm || '');
				} else {
					this.updatedSortLogicInitallyObserved = true;
				}
			}
		});
	</script>
</dom-module>
