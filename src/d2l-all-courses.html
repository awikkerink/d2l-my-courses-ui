<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../iron-scroll-threshold/iron-scroll-threshold.html">
<link rel="import" href="../../d2l-alert/d2l-alert.html">
<link rel="import" href="../../d2l-dropdown/d2l-dropdown.html">
<link rel="import" href="../../d2l-dropdown/d2l-dropdown-content.html">
<link rel="import" href="../../d2l-dropdown/d2l-dropdown-menu.html">
<link rel="import" href="../../d2l-hm-constants-behavior/d2l-hm-constants-behavior.html">
<link rel="import" href="../../d2l-icons/d2l-icons.html">
<link rel="import" href="../../d2l-link/d2l-link.html">
<link rel="import" href="../../d2l-loading-spinner/d2l-loading-spinner.html">
<link rel="import" href="../../d2l-menu/d2l-menu-item-radio.html">
<link rel="import" href="../../d2l-organization-hm-behavior/d2l-organization-hm-behavior.html">
<link rel="import" href="../../d2l-simple-overlay/d2l-simple-overlay.html">
<link rel="import" href="../../d2l-tabs/d2l-tabs.html">
<link rel="import" href="d2l-alert-behavior.html">
<link rel="import" href="d2l-all-courses-styles.html">
<link rel="import" href="d2l-course-management-behavior.html">
<link rel="import" href="d2l-course-tile-responsive-grid-behavior.html">
<link rel="import" href="d2l-filter-menu/d2l-filter-menu.html">
<link rel="import" href="d2l-search-widget-custom.html">
<link rel="import" href="d2l-utility-behavior.html">
<link rel="import" href="localize-behavior.html">
<link rel="import" href="d2l-all-courses-segregated-content.html">
<link rel="import" href="d2l-all-courses-unified-content.html">

<!--
`d2l-all-courses`
Polymer-based web component for all courses.

If the `US90527-my-courses-updates` LD flag is on, the `updated-sort-logic` attribute is added and the `d2l-all-courses-unified-content` component is rendered.
If it is off and the attribute is not added, the `d2l-all-courses-segregated-content` component is rendered.

-->

<dom-module id="d2l-all-courses">
	<template>
		<style include="d2l-all-courses-styles"></style>

		<d2l-simple-overlay
			id="all-courses"
			title-name="{{localize('allCourses')}}"
			close-simple-overlay-alt-text="{{localize('closeSimpleOverlayAltText')}}"
			with-backdrop
			restore-focus-on-close>

			<div hidden$="[[!_showContent]]">
				<iron-scroll-threshold
					id="all-courses-scroll-threshold"
					on-lower-threshold="_onAllCoursesLowerThreshold">
				</iron-scroll-threshold>

				<div id="search-and-filter">
					<div class="search-and-filter-row">
						<d2l-search-widget-custom
							id="search-widget"
							search-button-label="{{localize('search')}}"
							clear-button-label="{{localize('search.clearSearch')}}"
							search-action="[[_enrollmentsSearchAction]]"
							search-url="[[_searchUrl]]">
						</d2l-search-widget-custom>

						<div id="filterAndSort">
							<d2l-dropdown id="filterDropdown">
								<button
									class="d2l-dropdown-opener dropdown-button"
									aria-labelledby="filterText">
									<span id="filterText" class="dropdown-opener-text">[[_filterText]]</span>
									<d2l-icon icon="d2l-tier1:chevron-down" aria-hidden="true"></d2l-icon>
								</button>
								<d2l-dropdown-content id="filterDropdownContent" no-padding min-width="350" render-content>
									<d2l-filter-menu
										id="filterMenu"
										my-enrollments-entity="[[myEnrollmentsEntity]]",
										filter-standard-semester-name="[[filterStandardSemesterName]]",
										filter-standard-department-name="[[filterStandardDepartmentName]]">
									</d2l-filter-menu>
								</d2l-dropdown-content>
							</d2l-dropdown>

							<d2l-dropdown id="sortDropdown">
								<button
									class="d2l-dropdown-opener dropdown-button"
									aria-labelledby="sortText">
									<span id="sortText" class="dropdown-opener-text">{{localize('sorting.sortCourseName')}}</span>
									<d2l-icon icon="d2l-tier1:chevron-down" aria-hidden="true"></d2l-icon>
								</button>
								<d2l-dropdown-menu no-padding min-width="350">
									<d2l-menu id="sortDropdownMenu" label="{{localize('sorting.sortBy')}}">
										<div class="dropdown-content-header">
											<span>{{localize('sorting.sortBy')}}</span>
										</div>
										<d2l-menu-item-radio hidden$="[[!updatedSortLogic]]" class="dropdown-content-gradient" value="Default" text="{{localize('sorting.sortDefault')}}"></d2l-menu-item-radio>
										<d2l-menu-item-radio value="OrgUnitName" class$="[[_showDropdownGradient(updatedSortLogic)]]" text="{{localize('sorting.sortCourseName')}}"></d2l-menu-item-radio>
										<d2l-menu-item-radio value="OrgUnitCode" text="{{localize('sorting.sortCourseCode')}}"></d2l-menu-item-radio>
										<d2l-menu-item-radio value="PinDate" text="{{localize('sorting.sortDatePinned')}}"></d2l-menu-item-radio>
										<d2l-menu-item-radio value="LastAccessed" text="{{localize('sorting.sortLastAccessed')}}"></d2l-menu-item-radio>
										<d2l-menu-item-radio hidden$="[[!updatedSortLogic]]" value="EnrollmentDate" text="{{localize('sorting.sortEnrollmentDate')}}"></d2l-menu-item-radio>
									</d2l-menu>
								</d2l-dropdown-menu>
							</d2l-dropdown>
						</div>
					</div>
					<div class="search-and-filter-row advanced-search-link" hidden$="[[!_showAdvancedSearchLink]]" >
						<d2l-link href$="[[advancedSearchUrl]]">{{localize('advancedSearch')}}</d2l-link>
					</div>
				</div>

				<template is="dom-repeat" items="[[_alerts]]">
					<d2l-alert type="[[item.alertType]]">
						[[item.alertMessage]]
					</d2l-alert>
				</template>

				<template is="dom-if" if="[[updatedSortLogic]]">
					<d2l-tabs>
						<template items="[[tabSearchActions]]" is="dom-repeat">
							<d2l-tab-panel id="all-courses-tab-[[item.name]]" text="[[item.title]]" selected=[[item.selected]]></d2l-tab-panel>
						</template>
						<div hidden$="[[!_showTabContent]]">
							<d2l-all-courses-unified-content
								show-course-code="[[showCourseCode]]"
								show-semester="[[showSemester]]"
								course-updates-config="[[courseUpdatesConfig]]"
								updated-sort-logic="[[updatedSortLogic]]"
								total-filter-count="[[_totalFilterCount]]"
								filter-counts="[[_filterCounts]]"
								is-searched="[[_isSearched]]"
								filtered-enrollments="[[_filteredEnrollments]]"
							></d2l-all-courses-unified-content>
						</div>
						<d2l-loading-spinner
							hidden$="[[_showTabContent]]"
							size="100">
						</d2l-loading-spinner>
					</d2l-tabs>
				</template>
				<template is="dom-if" if="[[!updatedSortLogic]]">
					<d2l-all-courses-segregated-content
						show-course-code="[[showCourseCode]]"
						show-semester="[[showSemester]]"
						course-updates-config="[[courseUpdatesConfig]]"
						updated-sort-logic="[[updatedSortLogic]]"
						total-filter-count="[[_totalFilterCount]]"
						filter-counts="[[_filterCounts]]"
						is-searched="[[_isSearched]]"
						filtered-pinned-enrollments="[[_filteredPinnedEnrollments]]"
						filtered-unpinned-enrollments="[[_filteredUnpinnedEnrollments]]"
					></d2l-all-courses-segregated-content>
				</template>
				<d2l-loading-spinner
					id="lazyLoadSpinner"
					hidden$="[[!_hasMoreEnrollments]]"
					size="100">
				</d2l-loading-spinner>
			</div>
			<d2l-loading-spinner
				hidden$="[[_showContent]]"
				size="100">
			</d2l-loading-spinner>
		</d2l-simple-overlay>
	</template>
	<script>
		Polymer({
			is: 'd2l-all-courses',
			properties: {
				/*
				* Public Polymer properties
				*/

				// URL that directs to the advanced search page
				advancedSearchUrl: String,
				// Types of notifications to include in update count in course tile
				courseUpdatesConfig: Object,
				// Default option in Sort menu
				defaultSortValue: {
					type: String,
					value: 'OrgUnitName'
				},
				// Standard Department OU Type name to be displayed in the filter dropdown
				filterStandardDepartmentName: String,
				// Standard Semester OU Type name to be displayed in the filter dropdown
				filterStandardSemesterName: String,
				// Object containing the last response from an enrollments search request
				lastEnrollmentsSearchResponse: Object,
				// Entity returned from my-enrollments Link from the enrollments root
				myEnrollmentsEntity: {
					type: Object,
					value: function() { return {}; },
					observer: '_myEnrollmentsEntityChanged'
				},
				showCourseCode: Boolean,
				showSemester: Boolean,
				// Siren Actions corresponding to each tab that is displayed
				tabSearchActions: Array,
				// Feature flag (switch) for using the updated sort logic and related fetaures
				updatedSortLogic: {
					type: Boolean,
					value: false,
					observer: '_updatedSortLogicChanged'
				},

				/*
				* Private Polymer properties
				*/

				// search-my-enrollments Action
				_enrollmentsSearchAction: Object,
				// URL constructed to fetch a user's enrollments with the enrollments search Action
				_enrollmentsSearchUrl: String,
				// Filter dropdown opener text
				_filterText: String,
				// filtered pinned enrollment entities
				_filteredPinnedEnrollments: {
					type: Array,
					value: function() { return []; }
				},
				_filteredUnpinnedEnrollments: {
					type: Array,
					value: function() { return []; }
				},
				_filteredEnrollments: {
					type: Array,
					value: function() { return []; }
				},
				// True when there are any filtered enrollments (pinned or unpinned)
				_hasFilteredEnrollments: Boolean,
				// True when there are more enrollments to fetch (i.e. current page of enrollments has a `next` link)
				_hasMoreEnrollments: {
					type: Boolean,
					computed: '_computeHasMoreEnrollments(lastEnrollmentsSearchResponse, _showTabContent)'
				},
				// Object containing the IDs of previously loaded pinned enrollments, to avoid duplicates
				_pinnedCoursesMap: {
					type: Object,
					value: function() { return {}; }
				},
				// Object containing the IDs of previously loaded unpinned enrollments, to avoid duplicates
				_unpinnedCoursesMap: {
					type: Object,
					value: function() { return {}; }
				},
				// Object containing the IDs of previously loaded enrollments, to avoid duplicates
				_coursesMap: {
					type: Object,
					value: function() { return {}; }
				},
				// URL passed to search widget, called for searching
				_searchUrl: String,
				_showAdvancedSearchLink: {
					type: Boolean,
					value: false,
					computed: '_computeShowAdvancedSearchLink(advancedSearchUrl)'
				},
				_showContent: {
					type: Boolean,
					value: false
				},
				_showTabContent: {
					type: Boolean,
					value: false
				},
				// Number of filters currently selected; used to change opener text when menu closes
				_totalFilterCount: {
					type: Number,
					value: 0
				},
				_filterCounts: {
					type: Object,
					value: function() {
						return {
							departments: 0,
							semesters: 0,
							roles: 0
						};
					}
				},
				_updatedSortLogicInitallyObserved: {
					type: Boolean,
					value: false
				},
				_isSearched: Boolean
			},
			behaviors: [
				window.D2L.Hypermedia.HMConstantsBehavior,
				D2L.PolymerBehaviors.Hypermedia.OrganizationHMBehavior,
				D2L.PolymerBehaviors.MyCourses.LocalizeBehavior,
				D2L.MyCourses.AlertBehavior,
				D2L.MyCourses.CourseManagementBehavior,
				D2L.MyCourses.UtilityBehavior
			],
			listeners: {
				'd2l-simple-overlay-opening': '_onSimpleOverlayOpening',
				'd2l-tab-panel-selected': '_onTabSelected'
			},
			observers: [
				'_enrollmentsChanged(_filteredPinnedEnrollments.length, _filteredUnpinnedEnrollments.length)'
			],
			ready: function() {
				this._filterText = this.localize('filtering.filter');
			},
			attached: function() {
				this.listen(this.$.sortDropdown, 'd2l-menu-item-change', '_onSortOrderChanged');
				this.listen(this.$.filterDropdownContent, 'd2l-dropdown-open', '_onFilterDropdownOpen');
				this.listen(this.$.filterDropdownContent, 'd2l-dropdown-close', '_onFilterDropdownClose');
				this.listen(this.$.filterMenu, 'd2l-filter-menu-change', '_onFilterChanged');
				this.listen(this.$['search-widget'], 'd2l-search-widget-results-changed', '_onSearchResultsChanged');
			},
			detached: function() {
				this.unlisten(this.$.sortDropdown, 'd2l-menu-item-change', '_onSortOrderChanged');
				this.unlisten(this.$.filterDropdownContent, 'd2l-dropdown-open', '_onFilterDropdownOpen');
				this.unlisten(this.$.filterDropdownContent, 'd2l-dropdown-close', '_onFilterDropdownClose');
				this.unlisten(this.$.filterMenu, 'd2l-filter-menu-change', '_onFilterChanged');
				this.unlisten(this.$['search-widget'], 'd2l-search-widget-results-changed', '_onSearchResultsChanged');
			},

			/*
			* Public API methods
			*/

			load: function() {
				this.$['all-courses-scroll-threshold'].scrollTarget = this.$['all-courses'].scrollRegion;
				this.$['all-courses-scroll-threshold'].clearTriggers();
				if (this.updatedSortLogic) {
					this._filteredEnrollments.forEach(function(enrollment) {
						this._coursesMap[this.getEntityIdentifier(enrollment)] = true;
					}, this);
				} else {
					this._filteredPinnedEnrollments.forEach(function(enrollment) {
						this._pinnedCoursesMap[this.getEntityIdentifier(enrollment)] = true;
					}, this);
					this._filteredUnpinnedEnrollments.forEach(function(enrollment) {
						this._unpinnedCoursesMap[this.getEntityIdentifier(enrollment)] = true;
					}, this);
				}
			},
			open: function() {
				// Initially hide the content, until we have some data to show
				// (set back to true in _onSearchResultsChanged)
				this._showContent = false;

				this.$$('#all-courses').open();
				this.load();
			},
			setCourseImage: function(details) {
				this._removeAlert('setCourseImageFailure');

				if (details && details.detail) {
					if (details.detail.status === 'failure') {
						setTimeout(function() {
							this._addAlert('warning', 'setCourseImageFailure', this.localize('error.settingImage'));
						}.bind(this), 1000); // delay until the tile fail icon animation begins to kick in (1 sec delay)
					}
				}

				if (!this.updatedSortLogic) {
					this.$$('d2l-all-courses-segregated-content').setCourseImage(details);
				}
			},

			/*
			* Listeners
			*/

			_onAllCoursesLowerThreshold: function() {
				if (this.$['all-courses'].opened && this.lastEnrollmentsSearchResponse) {
					var lastResponseEntity = this.parseEntity(this.lastEnrollmentsSearchResponse);

					if (lastResponseEntity && lastResponseEntity.hasLinkByRel('next')) {
						this._enrollmentsSearchUrl = lastResponseEntity.getLinkByRel('next').href;
						this.$.lazyLoadSpinner.scrollIntoView();

						return this.fetchSirenEntity(this._enrollmentsSearchUrl)
							.then(function(enrollmentsEntity) {
								this._updateFilteredEnrollments(enrollmentsEntity, true);
							}.bind(this));
					}
				}
			},
			_onFilterChanged: function(e) {
				this._searchUrl = e.detail.url;
				this._filterCounts = e.detail.filterCounts;
				this._totalFilterCount = this._filterCounts.departments + this._filterCounts.semesters + this._filterCounts.roles;
			},
			_onFilterDropdownClose: function() {
				var text;
				if (this._totalFilterCount === 0) {
					text = this.localize('filtering.filter');
				} else if (this._totalFilterCount === 1) {
					text = this.localize('filtering.filterSingle');
				} else {
					text = this.localize('filtering.filterMultiple', 'num', this._totalFilterCount);
				}
				this.set('_filterText', text);
			},
			_onFilterDropdownOpen: function() {
				this.set('_filterText', this.localize('filtering.filter'));
				return this.$.filterMenu.open();
			},
			_onSortOrderChanged: function(e) {
				var langterm;
				var promotePins = false;

				switch (e.detail.value) {
					case 'OrgUnitName':
						langterm = 'sorting.sortCourseName';
						this._sortParameter = this.updatedSortLogic ? 'OrgUnitName,OrgUnitId' : '-PinDate,OrgUnitName,OrgUnitId';
						break;
					case 'OrgUnitCode':
						langterm = 'sorting.sortCourseCode';
						this._sortParameter = this.updatedSortLogic ? 'OrgUnitCode,OrgUnitId' : '-PinDate,OrgUnitCode,OrgUnitId';
						break;
					case 'PinDate':
						langterm = 'sorting.sortDatePinned';
						this._sortParameter = '-PinDate,OrgUnitId';
						promotePins = this.updatedSortLogic;
						break;
					case 'LastAccessed':
						langterm = 'sorting.sortLastAccessed';
						this._sortParameter = this.updatedSortLogic ? 'LastAccessed' : 'LastAccessed';
						break;
					case 'EnrollmentDate':
						langterm = 'sorting.sortEnrollmentDate';
						this._sortParameter = '-LastModifiedDate,OrgUnitId';
						break;
					case 'Default':
						langterm = 'sorting.sortDefault';
						this._sortParameter = 'Current';
						promotePins = true;
						break;
					default:
						langterm = this.updatedSortLogic ? 'sorting.sortDefault' : 'sorting.sortCourseName';
						this._sortParameter =  this.updatedSortLogic ? 'Current' : '-PinDate,OrgUnitName,OrgUnitId';
						promotePins = this.updatedSortLogic;
						break;
				}


				this._searchUrl = this.createActionUrl(this._enrollmentsSearchAction, {
					sort: this._sortParameter,
					promotePins: promotePins
				}) + '&bustCache=' + Math.random();

				this.$.sortText.textContent = this.localize(langterm || '');
				this.$.sortDropdown.toggleOpen();
			},
			_onSearchResultsChanged: function(e) {
				this._isSearched = this.$['search-widget']._showClearIcon;
				if (this.updatedSortLogic) {
					this._coursesMap = {};
				} else {
					this._pinnedCoursesMap = {};
					this._unpinnedCoursesMap = {};
				}
				this._updateFilteredEnrollments(e.detail, false);
				this.myEnrollmentsEntity = e.detail;
				this.fire('recalculate-columns');

				if (!this.updatedSortLogic) {
					this._showContent = true;

					// Forces recalculation of columns in d2l-all-courses-content-unified
					window.dispatchEvent(new Event('resize'));
					return;
				}

				this._showTabContent = true;

				// On initial load, search-results-changed will fire immediately
				// when the search component is rendered. We want to wait until
				// the second time is fired, after completing the default tab
				// search, before showing any content.
				this._showContent = !!this.tabSearchActions;

				setTimeout(function() {
					// Triggers the course tiles to resize after switching tab
					window.dispatchEvent(new Event('resize'));
				}, 10);
			},
			_onSimpleOverlayOpening: function() {
				this._removeAlert('setCourseImageFailure');
				this._clearSearchWidget();
				this.$.filterMenu.clearFilters();
				this._filterText = this.localize('filtering.filter');
				this._resetSortDropdown();
			},
			_onTabSelected: function(e) {
				var actionName = e.target.id.replace('all-courses-tab-', '');
				var tabAction = this.tabSearchActions.find(function(action) {
					return action.name === actionName;
				});
				if (!tabAction) {
					return;
				}

				this._showTabContent = false;
				this._searchUrl = this.createActionUrl(tabAction.enrollmentsSearchAction, {
					autoPinCourses: false,
					embedDepth: 1,
					sort: this._sortParameter || this.updatedSortLogic ? 'Current' : '-PinDate,OrgUnitName,OrgUnitId'
				});

				e.stopPropagation();
			},

			/*
			* Observers
			*/

			_enrollmentsChanged: function() {
				this.$['all-courses-scroll-threshold'].clearTriggers();
			},
			_myEnrollmentsEntityChanged: function(entity) {
				var myEnrollmentsEntity = this.parseEntity(entity);
				if (!myEnrollmentsEntity.hasActionByName(this.HypermediaActions.enrollments.searchMyEnrollments)) {
					return;
				}

				var searchAction = myEnrollmentsEntity.getActionByName(this.HypermediaActions.enrollments.searchMyEnrollments);
				this._enrollmentsSearchAction = searchAction;

				if (searchAction && searchAction.hasFieldByName('sort')) {
					var sortParameter = searchAction.getFieldByName('sort').value;
					if (!sortParameter) {
						return;
					}

					this._sortParameter = sortParameter;

					var sortMap = {
						'OrgUnitName,OrgUnitId': {
							name: 'OrgUnitName',
							langterm: 'sorting.sortCourseName'
						},
						// Only used if updatedSortLogic = false
						'-PinDate,OrgUnitName,OrgUnitId': {
							name: 'OrgUnitName',
							langterm: 'sorting.sortCourseName'
						},
						'OrgUnitCode,OrgUnitId': {
							name: 'OrgUnitCode',
							langterm: 'sorting.sortCourseCode'
						},
						// Only used if updatedSortLogic = false
						'-PinDate,OrgUnitCode,OrgUnitId': {
							name: 'OrgUnitCode',
							langterm: 'sorting.sortCourseCode'
						},
						'-PinDate,OrgUnitId': {
							name: 'PinDate',
							langterm: 'sorting.sortDatePinned'
						},
						'LastAccessed': {
							name: 'LastAccessed',
							langterm: 'sorting.sortLastAccessed'
						},
						'-LastModifiedDate,OrgUnitId': {
							name: 'EnrollmentDate',
							langterm: 'sorting.sortEnrollmentDate'
						},
						'Current': {
							name: 'Default',
							langterm: 'sorting.sortDefault'
						}
					};

					var sort = sortMap[this._sortParameter];
					if (sort) {
						this.$.sortText.textContent = this.localize(sort.langterm || '');
						this._selectSortOption(sort.name);
					} else {
						var langterm = this.updatedSortLogic ? 'sorting.sortDefault' : 'sorting.sortCourseName';
						this.$.sortText.textContent = this.localize(langterm);
						this._selectSortOption(this.defaultSortValue);
					}
				}
			},

			/*
			* Utility/helper functions
			*/

			_clearFilteredCourses: function() {
				if (this.updatedSortLogic) {
					this._coursesMap = {};
				} else {
					this._pinnedCoursesMap = {};
					this._unpinnedCoursesMap = {};
				}
			},
			_clearSearchWidget: function() {
				this.$['search-widget'].clear();
				this._clearFilteredCourses();
			},
			_computeHasMoreEnrollments: function(lastResponse, showTabContent) {
				if (!showTabContent) {
					return false;
				}

				lastResponse = this.parseEntity(lastResponse);
				return lastResponse.hasLinkByRel('next');
			},
			_computeShowAdvancedSearchLink: function(link) {
				return !!link;
			},
			_resetSortDropdown: function() {
				this._selectSortOption(this.defaultSortValue);

				var content = this.$.sortDropdown.queryEffectiveChildren('[d2l-dropdown-content]');
				if (content) {
					content.close();
				}
			},
			_selectSortOption: function(sortName) {
				var items = this.$.sortDropdownMenu.querySelectorAll('d2l-menu-item-radio');
				for (var i = 0; i < items.length; i++) {
					items[i].selected = false;
				}

				this.$.sortDropdownMenu.querySelector('d2l-menu-item-radio[value=' + sortName + ']').selected = true;
			},
			_updateFilteredEnrollments: function(enrollments, append) {
				var enrollmentEntities = enrollments.getSubEntitiesByClass(this.HypermediaClasses.enrollments.enrollment);

				if (this.updatedSortLogic) {
					enrollmentEntities.forEach(function(enrollment) {
						var enrollmentId = this.getEntityIdentifier(enrollment);
						this._coursesMap[enrollmentId] = true;
					}, this);
					if (append) {
						this._filteredEnrollments = this._filteredEnrollments.concat(enrollmentEntities);
					} else {
						this._filteredEnrollments = enrollmentEntities;
					}
				} else {
					var newPinnedEnrollments = [];
					var newUnpinnedEnrollments = [];
					enrollmentEntities.forEach(function(enrollment) {
						var enrollmentId = this.getEntityIdentifier(enrollment);

						if (enrollment.hasClass(this.HypermediaClasses.enrollments.pinned)) {
							if (!this._pinnedCoursesMap.hasOwnProperty(enrollmentId)) {
								newPinnedEnrollments.push(enrollment);
								this._pinnedCoursesMap[enrollmentId] = true;
							}
						} else {
							if (!this._unpinnedCoursesMap.hasOwnProperty(enrollmentId)) {
								newUnpinnedEnrollments.push(enrollment);
								this._unpinnedCoursesMap[enrollmentId] = true;
							}
						}
					}, this);

					if (append) {
						this._filteredPinnedEnrollments = this._filteredPinnedEnrollments.concat(newPinnedEnrollments);
						this._filteredUnpinnedEnrollments = this._filteredUnpinnedEnrollments.concat(newUnpinnedEnrollments);
					} else {
						this._filteredPinnedEnrollments = newPinnedEnrollments;
						this._filteredUnpinnedEnrollments = newUnpinnedEnrollments;
					}
				}

				this.lastEnrollmentsSearchResponse = enrollments;
				requestAnimationFrame(function() {
					window.dispatchEvent(new Event('resize')); // doing this so ie11 and older edge browser will get ms-grid style assigned
					this.$['all-courses-scroll-threshold'].clearTriggers();
				}.bind(this));
			},
			_showDropdownGradient: function(updatedSortLogic) {
				return updatedSortLogic ? '' : 'dropdown-content-gradient';
			},
			_updatedSortLogicChanged: function(updatedSortLogic) {
				if (this._updatedSortLogicInitallyObserved) {
					this.defaultSortValue = updatedSortLogic ? 'Default' : 'OrgUnitName';
					this._selectSortOption(this.defaultSortValue);
					var langterm = updatedSortLogic ? 'sorting.sortDefault' : 'sorting.sortCourseName';
					this.$.sortText.textContent = this.localize(langterm || '');
				} else {
					this._updatedSortLogicInitallyObserved = true;
				}
			}
		});
	</script>
</dom-module>
