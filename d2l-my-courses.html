<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-scroll-threshold/iron-scroll-threshold.html">
<link rel="import" href="../d2l-alert/d2l-alert.html">
<link rel="import" href="../d2l-fetch/d2l-fetch.html">
<link rel="import" href="../d2l-hm-constants-behavior/d2l-hm-constants-behavior.html">
<link rel="import" href="../d2l-link/d2l-link.html">
<link rel="import" href="../d2l-loading-spinner/d2l-loading-spinner.html">
<link rel="import" href="../d2l-simple-overlay/d2l-simple-overlay.html">
<link rel="import" href="../d2l-image-selector/d2l-basic-image-selector.html">
<link rel="import" href="../d2l-typography/d2l-typography-shared-styles.html">
<link rel="import" href="src/d2l-alert-behavior.html">
<link rel="import" href="src/d2l-all-courses.html">
<link rel="import" href="src/d2l-course-management-behavior.html">
<link rel="import" href="src/d2l-course-tile-grid.html">
<link rel="import" href="src/d2l-utility-behavior.html">
<link rel="import" href="src/localize-behavior.html">
<dom-module id="d2l-my-courses">
	<template>
		<style>
			:host {
				display: block;
			}
			@media not all and (hover: hover) {
				:host {
					-webkit-user-select: none;
					user-select: none;
				}
			}
			.my-courses-content {
				padding-top: 10px;
			}
			.spinner-container {
				display: flex;
				justify-content: center;
				align-items: center;
			}
			d2l-alert {
				display: block;
				margin-bottom: 20px;
				clear: both;
			}
		</style>

		<div class="spinner-container">
			<d2l-loading-spinner
				hidden$="[[_showContent]]"
				size="100">
			</d2l-loading-spinner>
		</div>

		<div hidden$="[[!_showContent]]" class="my-courses-content">
			<template is="dom-repeat" items="{{_alerts}}">
				<d2l-alert type="[[item.alertType]]">
					{{item.alertMessage}}
					<a
						is="d2l-link"
						href="Javascript:void(0);"
						hidden$="[[_hasEnrollments]]"
						on-tap="_refreshPage">{{localize('refresh')}}</a>
				</d2l-alert>
			</template>
			<d2l-course-tile-grid
				enrollments="[[pinnedEnrollments]]"
				tile-sizes="[[_tileSizes]]"
				locale="[[locale]]"
				show-course-code="[[showCourseCode]]"
				show-semester="[[showSemester]]"
				course-updates-config="[[courseUpdatesConfig]]"
				updated-sort-logic="[[updatedSortLogic]]">
			</d2l-course-tile-grid>
			<a
				is="d2l-link"
				id="viewAllCourses"
				hidden$="[[!_hasEnrollments]]"
				href="javascript:void(0);"
				on-tap="_openAllCoursesView"
				on-keypress="_keypressOpenAllCoursesView"
				on-mouseover="_createAllCourses"
				on-focus="_createAllCourses"
				tabindex="0" >
				<h3 class="d2l-body-standard">[[_viewAllCoursesText]]</h3>
			</a>
		</div>

		<div id="allCoursesPlaceholder">
		</div>

		<d2l-simple-overlay
			id="basic-image-selector-overlay"
			title-name="{{localize('changeImage')}}"
			close-simple-overlay-alt-text="{{localize('closeSimpleOverlayAltText')}}"
			with-backdrop>
			<iron-scroll-threshold
				id="image-selector-threshold"
				on-lower-threshold="_onChangeImageLowerThreshold">
			</iron-scroll-threshold>
			<d2l-basic-image-selector
				image-catalog-location="[[imageCatalogLocation]]"
				organization="[[_setImageOrg]]"
				course-image-upload-cb="[[courseImageUploadCb]]">
			</d2l-basic-image-selector>
		</d2l-simple-overlay>

	</template>
	<script>
		Polymer({
			is: 'd2l-my-courses',

			properties: {
				/*
				* Public Polymer properties
				*/

				// URL that directs to the advanced search page
				advancedSearchUrl: String,
				// URL that is called by the widget to fetch enrollments
				enrollmentsUrl: String,
				// URL that is called by the widget to fetch results from the course image catalog
				imageCatalogLocation: String,
				// Configuration value passed in to toggle course code
				showCourseCode: Boolean,
				// Configuration value passed in to toggle semester on course tile
				showSemester: Boolean,
				// Standard Semester OU Type name to be displayed in the all-courses filter dropdown
				standardDepartmentName: String,
				// Standard Department OU Type name to be displayed in the all-courses filter dropdown
				standardSemesterName: String,
				// Types of notifications to include in update count in course tile
				courseUpdatesConfig: Object,
				// Callback for upload in image-selector
				courseImageUploadCb: Function,
				// Feature flag (switch) for using the updated sort logic and related fetaures
				updatedSortLogic: Boolean,

				/*
				* Private Polymer properties
				*/

				_hasEnrollments: {
					type: Boolean,
					value: false
				},
				// True when there are pinned enrollments (i.e. `pinnedEnrollments.length > 0`)
				_hasPinnedEnrollments: {
					type: Boolean,
					value: false
				},
				// Object containing the last response from an enrollments search request
				_lastEnrollmentsSearchResponse: Object,
				// Object containing the IDs of previously loaded pinned enrollments, to avoid duplicates
				_pinnedCoursesMap: {
					type: Object,
					value: function() { return {}; }
				},
				// The organization which the user is selecting the image of
				_setImageOrg: Object,
				_showContent: {
					type: Boolean,
					value: false
				},
				// Size the tile should render with respect to vw
				_tileSizes: Object,
				// Object containing the IDs of previously loaded unpinned enrollments, to avoid duplicates
				_unpinnedCoursesMap: {
					type: Object,
					value: function() { return {}; }
				},
				orgUnitIdMap: {
					type: Object,
					value: function() { return {}; }
				},
				_hasMoreEnrollments: Boolean,
				_viewAllCoursesText: {
					type: Number,
					computed: '_getViewAllCoursesCount(_hasMoreEnrollments, pinnedEnrollments, unpinnedEnrollments)'
				}
			},
			behaviors: [
				window.D2L.Hypermedia.HMConstantsBehavior,
				window.D2L.MyCourses.CourseTileResponsiveGridBehavior,
				D2L.PolymerBehaviors.MyCourses.LocalizeBehavior,
				window.D2L.MyCourses.InteractionDetectionBehavior,
				window.D2L.MyCourses.CourseManagementBehavior,
				window.D2L.MyCourses.AlertBehavior,
				window.D2L.MyCourses.UtilityBehavior
			],
			listeners: {
				'open-change-image-view': '_onOpenChangeImageView',
				'clear-image-scroll-threshold': '_onClearImageScrollThreshold',
				'd2l-simple-overlay-closed': '_onSimpleOverlayClosed',
				'enrollment-pinned': '_onEnrollmentPinAction',
				'enrollment-unpinned': '_onEnrollmentPinAction',
				'tile-remove-complete': '_onTileRemoveComplete',
				'course-tile-organization': '_onCourseTileOrganization',
				'course-image-loaded': '_onCourseImageLoaded',
				'initially-visible-course-tile': '_onInitiallyVisibleCourseTile'
			},
			observers: [
				'_enrollmentsChanged(pinnedEnrollments.length, unpinnedEnrollments.length)',
				'_updateEnrollmentAlerts(_hasEnrollments, _hasPinnedEnrollments)'
			],
			ready: function() {
				this._updateEnrollmentAlerts(this._hasEnrollments, this._hasPinnedEnrollments);
				this._onEnrollmentPinnedMessage = this._onEnrollmentPinnedMessage.bind(this);
			},
			attached: function() {
				this.performanceMark('d2l.my-courses.attached');
				this._fetchRoot();

				document.body.addEventListener('d2l-course-pinned-change', this._onEnrollmentPinnedMessage, true);
				document.body.addEventListener('set-course-image', this._onSetCourseImage.bind(this));
				this.$$('d2l-course-tile-grid').addEventListener('startedInactiveAlert', this._onStartedInactiveAlert.bind(this));
				this.$['image-selector-threshold'].scrollTarget = this.$['basic-image-selector-overlay'].scrollRegion;
			},
			detached: function() {
				document.body.removeEventListener('d2l-course-pinned-change', this._onEnrollmentPinnedMessage, true);
				document.body.removeEventListener('set-course-image', this._onSetCourseImage.bind(this));
			},

			/*
			* Public API functions
			*/

			courseImageUploadCompleted: function(success) {
				if (success) {
					this.$['basic-image-selector-overlay'].close();
					this.$$('d2l-course-tile-grid').refreshCourseTileImage(this._setImageOrg);
				}
				this.focus();
			},

			focus: function() {
				if (this._setImageOrg && this.$$('d2l-course-tile-grid').focus(this._setImageOrg)) {
					return;
				}
				this.$.viewAllCourses.focus();
			},

			getCourseTileItemCount: function() {
				return this.pinnedEnrollments.length;
			},

			getLastOrgUnitId: function() {
				if (!this._setImageOrg) {
					return;
				}
				return this._getOrgUnitIdFromHref(this.getEntityIdentifier(this._setImageOrg));
			},

			/*
			* Non-Polymer properties
			*/

			_allCoursesCreated: false,
			_courseImagesLoadedEventCount: 0,
			_courseTileOrganizationEventCount: 0,
			_initiallyVisibleCourseTileCount: 0,

			/*
			* Listeners
			*/

			_onChangeImageLowerThreshold: function() {
				this.$$('d2l-basic-image-selector').loadMore(this.$['image-selector-threshold']);
			},
			_onClearImageScrollThreshold: function() {
				this.$['image-selector-threshold'].clearTriggers();
			},
			_onEnrollmentPinAction: function(e) {
				var isPinned = e.type === 'enrollment-pinned';
				var orgUnitId = this._getOrgUnitIdFromHref(this.getEntityIdentifier(e.detail.organization));

				if (!orgUnitId) {
					return;
				}

				this.fire(
					'd2l-course-pinned-change', {
						orgUnitId: orgUnitId,
						isPinned: isPinned
					}
				);
			},
			_onEnrollmentPinnedMessage: function(e) {
				if (e.target === this) return;

				var enrollment = this.orgUnitIdMap[e.detail.orgUnitId];
				if (enrollment) {
					if (e.detail.isPinned) {
						this._moveEnrollmentToPinnedList(enrollment);
					} else {
						this._moveEnrollmentToUnpinnedList(enrollment);
					}
					setTimeout(this._onStartedInactiveAlert.bind(this), 50);
				} else {
					this.fetchSirenEntity(this.enrollmentsUrl)
						.then(this._refetchEnrollments.bind(this));
				}
			},
			_onStartedInactiveAlert: function(e) {
				var type = e && e.detail && e.detail.type;

				this._removeAlert('startedInactiveCourses');
				if (this.$$('d2l-course-tile-grid').checkForStartedInactive(type)) {
					this._addAlert('warning', 'startedInactiveCourses', this.localize('startedInactiveAlert'));
				}
			},
			_onSimpleOverlayClosed: function() {
				this._removeAlert('setCourseImageFailure');
				// update the startedInactive alert in case the user changed the pinned states in the overlay
				this._onStartedInactiveAlert();
			},
			_onOpenChangeImageView: function(e) {
				if (e.detail.organization) {
					this._setImageOrg = e.detail.organization;
				}

				this.$['basic-image-selector-overlay'].open();
			},
			_onSetCourseImage: function(e) {
				this._removeAlert('setCourseImageFailure');
				if (e && e.detail) {
					if (e.detail.status === 'failure') {
						setTimeout(function() {
							this._addAlert('warning', 'setCourseImageFailure', this.localize('error.settingImage'));
						}.bind(this), 1000); // delay until the tile fail icon animation begins to kick in (1 sec delay)
					}
				}
				if (this._allCoursesCreated) {
					this.$$('d2l-all-courses').setCourseImage(e);
				}
				this.$$('d2l-course-tile-grid').setCourseImage(e);
			},
			_onTileRemoveComplete: function(e) {
				if (e.detail.pinned) {
					this._moveEnrollmentToPinnedList(e.detail.enrollment);
				} else {
					this._moveEnrollmentToUnpinnedList(e.detail.enrollment);
				}
			},
			_onInitiallyVisibleCourseTile: function() {
				this._initiallyVisibleCourseTileCount++;
			},
			_onCourseImageLoaded: function() {
				this._courseImagesLoadedEventCount++;

				if (this._courseImagesLoadedEventCount === this._initiallyVisibleCourseTileCount) {
					this.performanceMark('d2l.my-courses.visible-images-complete');
					this.performanceMeasure(
						'd2l.my-courses',
						'd2l.my-courses.attached',
						'd2l.my-courses.visible-images-complete'
					);
				}
			},
			_onCourseTileOrganization: function() {
				if (this._initiallyVisibleCourseTileCount === 0 && this._courseTileOrganizationEventCount === 0) {
					// If no course tiles are initially visible (widget is outside of initial viewport)
					// then we can say we're already finished loading the visible organizations and images
					this.performanceMark('d2l.my-courses.visible-organizations-complete');
					this.performanceMeasure(
						'd2l.my-courses.meaningful.visible',
						'd2l.my-courses.attached',
						'd2l.my-courses.visible-organizations-complete'
					);
					this.performanceMark('d2l.my-courses.visible-images-complete');
					this.performanceMeasure(
						'd2l.my-courses',
						'd2l.my-courses.attached',
						'd2l.my-courses.visible-images-complete'
					);
				}

				this._courseTileOrganizationEventCount++;

				if (this._courseTileOrganizationEventCount === this._initiallyVisibleCourseTileCount) {
					this.performanceMark('d2l.my-courses.visible-organizations-complete');
					this.performanceMeasure(
						'd2l.my-courses.meaningful.visible',
						'd2l.my-courses.attached',
						'd2l.my-courses.visible-organizations-complete'
					);
				} else if (this._courseTileOrganizationEventCount === this.pinnedEnrollments.length) {
					this.performanceMark('d2l.my-courses.all-organizations-complete');
					this.performanceMeasure(
						'd2l.my-courses.meaningful.all',
						'd2l.my-courses.attached',
						'd2l.my-courses.all-organizations-complete'
					);
				}
			},

			/*
			* Observers
			*/

			_enrollmentsChanged: function() {
				this.set('_hasPinnedEnrollments', this.pinnedEnrollments.length > 0);
				this.set('_hasEnrollments', this._hasPinnedEnrollments || this.unpinnedEnrollments.length > 0);
			},
			_updateEnrollmentAlerts: function(hasEnrollments, hasPinnedEnrollments) {
				this._clearAlerts();

				if (hasEnrollments) {
					if (!hasPinnedEnrollments) {
						this._addAlert('call-to-action', 'noPinnedCourses', this.localize('noPinnedCoursesMessage'));
					}
				} else {
					this._addAlert('call-to-action', 'noCourses', this.localize('noCoursesMessage'));
				}
			},

			/*
			* Utility/helper functions
			*/

			_addEnrollmentToList: function(pinned, enrollmentEntity) {
				var listName = (pinned ? 'pinned' : 'unpinned') + 'Enrollments';

				this._setEnrollmentPinData(enrollmentEntity, pinned);
				this.unshift(listName, enrollmentEntity);
			},
			_createAllCourses: function() {
				if (!this._allCoursesCreated) {
					var allCourses = document.createElement('d2l-all-courses');
					this.$.allCoursesPlaceholder.appendChild(allCourses);
					this._allCoursesCreated = true;
				}
			},
			_keypressOpenAllCoursesView: function(e) {
				if (e.code === 'Space' || e.code === 'Enter') {
					return this._openAllCoursesView(e);
				}
			},
			_fetchRoot: function() {
				this.performanceMark('d2l.my-courses.root-enrollments.request');

				var showContent = function() {
					this._showContent = true;
				}.bind(this);

				return this.fetchSirenEntity(this.enrollmentsUrl)
					.then(this._fetchEnrollments.bind(this))
					.then(showContent)
					.catch(showContent);
			},
			_fetchEnrollments: function(enrollmentsRootEntity) {

				this.performanceMark('d2l.my-courses.root-enrollments.response');
				this.performanceMeasure(
					'd2l.my-courses.root-enrollments',
					'd2l.my-courses.root-enrollments.request',
					'd2l.my-courses.root-enrollments.response'
				);

				if (!enrollmentsRootEntity.hasAction('search-my-enrollments')) {
					return Promise.resolve();
				}

				var searchUrl = this._createFetchEnrollmentsUrl(enrollmentsRootEntity);

				this.performanceMark('d2l.my-courses.search-enrollments.request');
				return this.fetchSirenEntity(searchUrl)
					.then(this._enrollmentsResponsePerfMeasures.bind(this))
					.then(this._populateEnrollments.bind(this));
			},
			_enrollmentsResponsePerfMeasures: function(enrollmentsEntity) {
				this.performanceMark('d2l.my-courses.search-enrollments.response');
				this.performanceMeasure(
					'd2l.my-courses.search-enrollments',
					'd2l.my-courses.search-enrollments.request',
					'd2l.my-courses.search-enrollments.response'
				);

				return Promise.resolve(enrollmentsEntity);
			},
			_createFetchEnrollmentsUrl: function(enrollmentsRootEntity, bustCache) {
				var searchAction = enrollmentsRootEntity.getActionByName('search-my-enrollments');
				var pageSize = this.updatedSortLogic ? 50 : 25;

				var query = {
					pageSize: pageSize,
					embedDepth: 1,
					sort: '-PinDate,OrgUnitName,OrgUnitId',
					autoPinCourses: true
				};
				var enrollmentsSearchUrl = this.createActionUrl(searchAction, query);
				if (bustCache) enrollmentsSearchUrl += '&bustCache=' + Math.random();

				return enrollmentsSearchUrl;
			},
			_refetchEnrollments: function(enrollmentsRootEntity) {

				if (!enrollmentsRootEntity.hasAction('search-my-enrollments')) {
					return Promise.resolve();
				}

				var enrollmentsSearchUrl = this._createFetchEnrollmentsUrl(enrollmentsRootEntity, true);

				return this.fetchSirenEntity(enrollmentsSearchUrl)
					.then(this._populateEnrollments.bind(this));
			},
			_populateEnrollments: function(enrollmentsEntity) {

				this._lastEnrollmentsSearchResponse = enrollmentsEntity;
				var enrollmentEntities = enrollmentsEntity.getSubEntitiesByClass('enrollment');
				this._hasMoreEnrollments = enrollmentsEntity.hasLinkByRel('next');
				var newPinnedEnrollments = [];
				var newUnpinnedEnrollments = [];

				enrollmentEntities.forEach(function(enrollment) {
					var enrollmentId = this.getEntityIdentifier(enrollment);

					if (enrollment.hasClass('pinned')) {
						if (!this._pinnedCoursesMap.hasOwnProperty(enrollmentId)) {
							newPinnedEnrollments.push(enrollment);
							this._pinnedCoursesMap[enrollmentId] = true;
						}
					} else {
						if (!this._unpinnedCoursesMap.hasOwnProperty(enrollmentId)) {
							newUnpinnedEnrollments.push(enrollment);
							this._unpinnedCoursesMap[enrollmentId] = true;
						}
					}

					var orgHref = (enrollment.getLinkByRel(this.HypermediaRels.organization) || {}).href;
					var orgUnitId = this._getOrgUnitIdFromHref(orgHref);
					if (!this.orgUnitIdMap.hasOwnProperty(orgUnitId)) {
						this.orgUnitIdMap[orgUnitId] = enrollment;
					}
				}, this);

				this.pinnedEnrollments = this.pinnedEnrollments.concat(newPinnedEnrollments);
				this.unpinnedEnrollments = this.unpinnedEnrollments.concat(newUnpinnedEnrollments);

				var colNum = this._calcNumColumns(this._getAvailableWidth(Polymer.dom(this.root).node.host), this.pinnedEnrollments.length);
				this._tileSizes = (colNum === 2) ?
					{ mobile: { maxwidth: 767, size: 50 }, tablet: { maxwidth: 1243, size: 33 }, desktop: { size: 20 } } :
					{ mobile: { maxwidth: 767, size: 100 }, tablet: { maxwidth: 1243, size: 67 }, desktop: { size: 25 } };

				this.fire('recalculate-columns');

				var lastEnrollment = enrollmentEntities[enrollmentEntities.length - 1];
				if (lastEnrollment.hasClass('pinned') && this._hasMoreEnrollments) {
					var url = enrollmentsEntity.getLinkByRel('next').href;
					return this.fetchSirenEntity(url)
						.then(this._populateEnrollments.bind(this));
				}
			},
			_moveEnrollmentToPinnedList: function(enrollment) {
				var enrollmentId, enrollmentEntity;

				if (typeof enrollment === 'string') {
					enrollmentId = enrollment;
				} else {
					enrollmentEntity = enrollment;
					enrollmentId = this.getEntityIdentifier(enrollmentEntity);
				}

				for (var index = 0; index < this.unpinnedEnrollments.length; index++) {
					var pinnedEnrollmentId = this.getEntityIdentifier(this.unpinnedEnrollments[index]);
					if (pinnedEnrollmentId === enrollmentId) {
						enrollmentEntity = enrollmentEntity || this.unpinnedEnrollments[index];
						this.splice('unpinnedEnrollments', index, 1);
						break;
					}
				}

				if (enrollmentEntity) {
					this._addEnrollmentToList(true, enrollmentEntity);
				}
			},
			_moveEnrollmentToUnpinnedList: function(enrollment) {
				var enrollmentId, enrollmentEntity;

				if (typeof enrollment === 'string') {
					enrollmentId = enrollment;
				} else {
					enrollmentEntity = enrollment;
					enrollmentId = this.getEntityIdentifier(enrollmentEntity);
				}

				for (var index = 0; index < this.pinnedEnrollments.length; index++) {
					var unpinnedEnrollmentId = this.getEntityIdentifier(this.pinnedEnrollments[index]);
					if (unpinnedEnrollmentId === enrollmentId) {
						enrollmentEntity = enrollmentEntity || this.pinnedEnrollments[index];
						this.splice('pinnedEnrollments', index, 1);
						break;
					}
				}

				if (enrollmentEntity) {
					this._addEnrollmentToList(false, enrollmentEntity);
				}
			},
			_openAllCoursesView: function(e) {
				this._createAllCourses();

				var allCourses = this.$$('d2l-all-courses');
				allCourses.open();

				e.preventDefault();
				e.stopPropagation();

				this.async(function() {
					// The opening of the overlay lags slightly if we try to do this while it
					// is opening - do it after the animation is finished. Animation takes
					// 500ms, but some lag if we wait exactly that long, so +100ms for safety)
					allCourses.pinnedEnrollments = this.pinnedEnrollments;
					allCourses.unpinnedEnrollments = this.unpinnedEnrollments;
					allCourses.myEnrollmentsEntity = this._lastEnrollmentsSearchResponse;
					allCourses.lastEnrollmentsSearchResponse = this._lastEnrollmentsSearchResponse;
					allCourses.locale = this.locale;
					allCourses.showCourseCode = this.showCourseCode;
					allCourses.showSemester = this.showSemester;
					allCourses.advancedSearchUrl = this.advancedSearchUrl;
					allCourses.filterStandardSemesterName = this.standardSemesterName;
					allCourses.filterStandardDepartmentName = this.standardDepartmentName;
					allCourses.courseUpdatesConfig = this.courseUpdatesConfig;
					allCourses.updatedSortLogic = this.updatedSortLogic;

					this.$$('d2l-all-courses').load();
				}.bind(this), 600);
			},
			_refreshPage: function() {
				document.location.reload(true);
			},
			_getOrgUnitIdFromHref: function(organizationHref) {
				var match = /[0-9]+$/.exec(organizationHref);

				if (!match) {
					return;
				}
				return match[0];
			},
			_getViewAllCoursesCount: function(_hasMoreEnrollments, pinnedEnrollments, unpinnedEnrollments) {
				var viewAllCourses = this.localize('viewAllCourses');
				if (!this.updatedSortLogic) return viewAllCourses;

				var count = String(pinnedEnrollments.length + unpinnedEnrollments.length);
				if (_hasMoreEnrollments) count += '+';

				return count.length > 0 ? viewAllCourses + ' (' + count + ')' : viewAllCourses;
			}
		});
	</script>
</dom-module>
