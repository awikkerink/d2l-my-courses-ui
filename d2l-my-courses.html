<script src="../fetch/fetch.js"></script>
<script src="polyfill/Array.prototype.includes.js"></script>
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-scroll-threshold/iron-scroll-threshold.html">
<link rel="import" href="../d2l-alert/d2l-alert.html">
<link rel="import" href="../d2l-fetch/d2l-fetch.html">
<link rel="import" href="../d2l-hm-constants-behavior/d2l-hm-constants-behavior.html">
<link rel="import" href="../d2l-link/d2l-link.html">
<link rel="import" href="../d2l-loading-spinner/d2l-loading-spinner.html">
<link rel="import" href="../d2l-simple-overlay/d2l-simple-overlay.html">
<link rel="import" href="../d2l-image-selector/d2l-basic-image-selector.html">
<link rel="import" href="../d2l-typography/d2l-typography-shared-styles.html">
<link rel="import" href="d2l-alert-behavior.html">
<link rel="import" href="d2l-all-courses.html">
<link rel="import" href="d2l-course-management-behavior.html">
<link rel="import" href="d2l-course-tile-grid.html">
<link rel="import" href="d2l-utility-behavior.html">
<link rel="import" href="localize-behavior.html">

<dom-module id="d2l-my-courses">
	<template>
		<style>
			:host {
				display: block;
			}
			@media not all and (hover: hover) {
				:host {
					-webkit-user-select: none;
					user-select: none;
				}
			}
			.my-courses-content {
				padding-top: 10px;
			}
			.spinner-container {
				display: flex;
				justify-content: center;
				align-items: center;
			}
			d2l-alert {
				display: block;
				margin-bottom: 20px;
				clear: both;
			}
		</style>

		<div class="spinner-container">
			<d2l-loading-spinner
				hidden$="[[_showContent]]"
				size="100">
			</d2l-loading-spinner>
		</div>

		<div hidden$="[[!_showContent]]" class="my-courses-content">
			<template is="dom-repeat" items="{{_alerts}}">
				<d2l-alert type="[[item.alertType]]">
					{{item.alertMessage}}
					<a
						is="d2l-link"
						href="Javascript:void(0);"
						hidden$="[[_hasEnrollments]]"
						on-tap="_refreshPage">{{localize('refresh')}}</a>
				</d2l-alert>
			</template>
			<d2l-course-tile-grid
				enrollments="[[pinnedEnrollments]]"
				tile-sizes="[[_tileSizes]]"
				user-id="[[userId]]"
				tenant-id="[[tenantId]]"
				locale="[[locale]]"
				telemetry-endpoint="[[telemetryEndpoint]]"
				show-course-code="[[showCourseCode]]"
				show-semester="[[showSemester]]"
				course-updates-config="[[courseUpdatesConfig]]">
			</d2l-course-tile-grid>
			<a
				is="d2l-link"
				id="viewAllCourses"
				hidden$="[[!_hasEnrollments]]"
				href="javascript:void(0);"
				on-tap="_openAllCoursesView"
				on-keypress="_keypressOpenAllCoursesView"
				on-mouseover="_createAllCourses"
				on-focus="_createAllCourses"
				tabindex="0" >
				<h3 class="d2l-body-standard">[[localize('viewAllCourses')]]</h3>
			</a>
		</div>

		<div id="allCoursesPlaceholder">
		</div>

		<d2l-simple-overlay
			id="basic-image-selector-overlay"
			title-name="{{localize('changeImage')}}"
			close-simple-overlay-alt-text="{{localize('closeSimpleOverlayAltText')}}"
			with-backdrop>
			<iron-scroll-threshold
				id="image-selector-threshold"
				on-lower-threshold="_onChangeImageLowerThreshold">
			</iron-scroll-threshold>
			<d2l-basic-image-selector
				image-catalog-location="[[imageCatalogLocation]]"
				organization="[[_setImageOrg]]"
				user-id="[[userId]]"
				tenant-id="[[tenantId]]"
				telemetry-endpoint="[[telemetryEndpoint]]"
				course-image-upload-cb="[[courseImageUploadCb]]">
			</d2l-basic-image-selector>
		</d2l-simple-overlay>

	</template>

	<script>
		'use strict';

		Polymer({
			is: 'd2l-my-courses',

			properties: {
				/*
				* Public Polymer properties
				*/

				// URL that directs to the advanced search page
				advancedSearchUrl: String,
				// URL that is called by the widget to fetch enrollments
				enrollmentsUrl: String,
				// URL that is called by the widget to fetch results from the course image catalog
				imageCatalogLocation: String,
				// Configuration value passed in to toggle course code
				showCourseCode: Boolean,
				// Configuration value passed in to toggle semester on course tile
				showSemester: Boolean,
				// Standard Semester OU Type name to be displayed in the all-courses filter dropdown
				standardDepartmentName: String,
				// Standard Department OU Type name to be displayed in the all-courses filter dropdown
				standardSemesterName: String,
				// URL to send telemetry to
				telemetryEndpoint: String,
				// hashed tenantid to send to telemetry
				tenantId: String,
				// hashed userid to send to telemetry
				userId: String,
				// Types of notifications to include in update count in course tile
				courseUpdatesConfig: Object,
				// Callback for upload in image-selector
				courseImageUploadCb: Function,

				/*
				* Private Polymer properties
				*/

				// URL used by the search widget to fetch department-type organizations
				_departmentsUrl: String,
				// URL constructed to fetch a user's enrollments with the enrollments search Action
				_enrollmentsSearchUrl: String,
				// True when there are any enrollments (pinned or unpinned)
				_hasEnrollments: {
					type: Boolean,
					value: false
				},
				// True when there are pinned enrollments (i.e. `pinnedEnrollments.length > 0`)
				_hasPinnedEnrollments: {
					type: Boolean,
					value: false
				},
				// Object containing the last response from an enrollments search request
				_lastEnrollmentsSearchResponse: Object,
				// Object containing the IDs of previously loaded pinned enrollments, to avoid duplicates
				_pinnedCoursesMap: {
					type: Object,
					value: function() { return {}; }
				},
				// URL used by the search widget to fetch semester-type organizations
				_semestersUrl: String,
				// The organization which the user is selecting the image of
				_setImageOrg: Object,
				_showContent: {
					type: Boolean,
					value: false
				},
				_startedInactive: Boolean,
				// Size the tile should render with respect to vw
				_tileSizes: Object,
				// Object containing the IDs of previously loaded unpinned enrollments, to avoid duplicates
				_unpinnedCoursesMap: {
					type: Object,
					value: function() { return {}; }
				},
				_performanceTracking: {
					type: Object,
					value: {
						'course-tile-first-render': {
							name: 'd2l.my-courses.tiles.rendered',
							count: 0,
							startMark: 'd2l.my-courses.search-enrollments.response'
						},
						'course-tile-organization': {
							name: 'd2l.my-courses.tiles.organizations',
							count: 0,
							startMark: 'd2l.my-courses.search-enrollments.response'
						},
						'course-image-loaded': {
							name: 'd2l.my-courses.tiles.images',
							count: 0,
							startMark: 'd2l.my-courses.tiles.first-organization'
						}
					}
				},
				orgUnitIdMap: {
					type: Object,
					value: function() { return {}; }
				}
			},
			behaviors: [
				window.D2L.Hypermedia.HMConstantsBehavior,
				window.D2L.MyCourses.CourseTileResponsiveGridBehavior,
				window.D2L.MyCourses.LocalizeBehavior,
				window.D2L.MyCourses.InteractionDetectionBehavior,
				window.D2L.MyCourses.CourseManagementBehavior,
				window.D2L.MyCourses.AlertBehavior,
				window.D2L.MyCourses.UtilityBehavior
			],
			listeners: {
				'open-change-image-view': '_onOpenChangeImageView',
				'set-course-image': '_onSetCourseImage',
				'clear-image-scroll-threshold': '_onClearImageScrollThreshold',
				'd2l-simple-overlay-closed': '_onSimpleOverlayClosed',
				'enrollment-pinned': '_onEnrollmentPinAction',
				'enrollment-unpinned': '_onEnrollmentPinAction',
				'tile-remove-complete': '_onTileRemoveComplete',
				'course-tile-first-render': '_onPerformanceEvent',
				'course-tile-organization': '_onPerformanceEvent',
				'course-image-loaded': '_onPerformanceEvent'
			},
			observers: [
				'_enrollmentsChanged(pinnedEnrollments.length, unpinnedEnrollments.length)',
				'_updateEnrollmentAlerts(_hasEnrollments, _hasPinnedEnrollments)'
			],
			ready: function() {
				this._updateEnrollmentAlerts(this._hasEnrollments, this._hasPinnedEnrollments);
				this._onEnrollmentPinnedMessage = this._onEnrollmentPinnedMessage.bind(this);
			},
			attached: function() {
				this.performanceMark('d2l.my-courses.attached');
				this._fetchRoot();

				document.body.addEventListener('d2l-course-pinned-change', this._onEnrollmentPinnedMessage, true);
				this.$$('d2l-course-tile-grid').addEventListener('startedInactiveAlert', this._onStartedInactiveAlert.bind(this));
				this.$['image-selector-threshold'].scrollTarget = this.$['basic-image-selector-overlay'].scrollRegion;
			},
			detached: function() {
 				document.body.removeEventListener('d2l-course-pinned-change', this._onEnrollmentPinnedMessage, true);
			},

			/*
			* Public API functions
			*/

			courseImageUploadCompleted: function(success) {
				if (success) {
					this.$['basic-image-selector-overlay'].close();
					this.$$('d2l-course-tile-grid').refreshCourseTileImage(this._setImageOrg);
				}
				this.focus();
			},

			focus: function() {
				if (this._setImageOrg && this.$$('d2l-course-tile-grid').focus(this._setImageOrg)) {
					return;
				}
				this.$.viewAllCourses.focus();
			},

			getCourseTileItemCount: function() {
				return this.pinnedEnrollments.length;
			},

			getLastOrgUnitId: function() {
				if (!this._setImageOrg) {
					return;
				}
				return this._getOrgUnitId(this._setImageOrg);
			},

			/*
			* Non-Polymer properties
			*/

			_allCoursesCreated: false,

			/*
			* Listeners
			*/

			_onChangeImageLowerThreshold: function() {
				this.$$('d2l-basic-image-selector').loadMore(this.$['image-selector-threshold']);
			},
			_onClearImageScrollThreshold: function() {
				this.$['image-selector-threshold'].clearTriggers();
			},
			_onEnrollmentPinAction: function(e) {
				var isPinned = e.type === 'enrollment-pinned';
				var orgUnitId = this._getOrgUnitId(e.detail.organization);

				if (!orgUnitId) {
					return;
				}

				this.fire(
					'd2l-course-pinned-change', {
						orgUnitId: orgUnitId,
						isPinned: isPinned
					}
				);
			},
			_onEnrollmentPinnedMessage: function(e) {
 				if (e.target !== this) {
					// TODO: Not necessary once parsed down to orgUnitId
					var orgUnitIdLink = 'http://KLX1-TJONES:44453/d2l/api/hm/organizations/' + e.detail.orgUnitId;
 					var enrollment = this.orgUnitIdMap[orgUnitIdLink];

 					if (enrollment) {
 						if (e.detail.isPinned) {
 							this._moveEnrollmentToPinnedList(enrollment);
 						} else {
 							this._moveEnrollmentToUnpinnedList(enrollment);
 						}
 						setTimeout(this._onStartedInactiveAlert.bind(this), 50);
 					} else {
						this.fetchSirenEntity(this.enrollmentsUrl)
							.then(this._refetchEnrollments.bind(this))
 					}
 				}
 			},
			_onStartedInactiveAlert: function(e) {
				var type = e && e.detail && e.detail.type;

				this._removeAlert('startedInactiveCourses');
				if (this.$$('d2l-course-tile-grid').checkForStartedInactive(type)) {
					this._addAlert('warning', 'startedInactiveCourses', this.localize('startedInactiveAlert'));
				}
			},
			_onSimpleOverlayClosed: function() {
				this._removeAlert('setCourseImageFailure');
				// update the startedInactive alert in case the user changed the pinned states in the overlay
				this._onStartedInactiveAlert();
			},
			_onOpenChangeImageView: function(e) {
				if (e.detail.organization) {
					this._setImageOrg = e.detail.organization;
				}

				this.$['basic-image-selector-overlay'].open();
			},
			_onSetCourseImage: function(e) {
				this._removeAlert('setCourseImageFailure');
				if (e && e.detail) {
					if (e.detail.status === 'failure') {
						setTimeout(function() {
							this._addAlert('warning', 'setCourseImageFailure', this.localize('error.settingImage'));
						}.bind(this), 1000); // delay until the tile fail icon animation begins to kick in (1 sec delay)
					}
				}
				if (this._allCoursesCreated) {
					this.$$('d2l-all-courses').setCourseImage(e);
				}
				this.$$('d2l-course-tile-grid').setCourseImage(e);
			},
			_onTileRemoveComplete: function(e) {
				if (e.detail.pinned) {
					this._moveEnrollmentToPinnedList(e.detail.enrollment);
				} else {
					this._moveEnrollmentToUnpinnedList(e.detail.enrollment);
				}
			},
			_onPerformanceEvent: function(e) {

				var data = this._performanceTracking[e.type];
				if (data === undefined || data.count >= this.pinnedEnrollments.length) return;

				data.count++;
				if (e.type === 'course-tile-organization' && data.count === 1) {
					this.performanceMark('d2l.my-courses.tiles.first-organization');
				}
				if (data.count === this.pinnedEnrollments.length) {
					this.performanceMark(data.name);
					this.performanceMeasure(data.name, data.startMark, data.name);
				}

				// once we've seen all events for every tile, my-courses is "complete"
				for (var key in this._performanceTracking) {
					if (this._performanceTracking[key].count < this.pinnedEnrollments.length) {
						return;
					}
				}
				this.performanceMark('d2l.my-courses.complete');
				this.performanceMeasure('d2l.my-courses', 'd2l.my-courses.attached', 'd2l.my-courses.complete');

			},

			/*
			* Observers
			*/

			_enrollmentsChanged: function() {
				this.set('_hasPinnedEnrollments', this.pinnedEnrollments.length > 0);
				this.set('_hasEnrollments', this._hasPinnedEnrollments || this.unpinnedEnrollments.length > 0);
			},
			_updateEnrollmentAlerts: function(hasEnrollments, hasPinnedEnrollments) {
				this._clearAlerts();

				if (hasEnrollments) {
					if (!hasPinnedEnrollments) {
						this._addAlert('call-to-action', 'noPinnedCourses', this.localize('noPinnedCoursesMessage'));
					}
				} else {
					this._addAlert('call-to-action', 'noCourses', this.localize('noCoursesMessage'));
				}
			},

			/*
			* Utility/helper functions
			*/

			_addEnrollmentToList: function(pinned, enrollmentEntity) {
				var listName = (pinned ? 'pinned' : 'unpinned') + 'Enrollments';

				this._setEnrollmentPinData(enrollmentEntity, pinned);
				this.unshift(listName, enrollmentEntity);
			},
			_createAllCourses: function() {
				if (!this._allCoursesCreated) {
					var allCourses = document.createElement('d2l-all-courses');
					this.$.allCoursesPlaceholder.appendChild(allCourses);
					this._allCoursesCreated = true;
				}
			},
			_keypressOpenAllCoursesView: function(e) {
				if ( e.code === 'Space' || e.code === 'Enter' ) {
					return this._openAllCoursesView(e);
				}
			},
			_fetchRoot: function() {
				this.performanceMark('d2l.my-courses.root-enrollments.request');

				var showContent = function() {
					this._showContent = true;
				}.bind(this);

				return this.fetchSirenEntity(this.enrollmentsUrl)
					.then(this._fetchEnrollments.bind(this))
					.then(showContent)
					.catch(showContent);
			},
			_fetchEnrollments: function(enrollmentsRootEntity) {

				this.performanceMark('d2l.my-courses.root-enrollments.response');
				this.performanceMeasure(
					'd2l.my-courses.root-enrollments',
					'd2l.my-courses.root-enrollments.request',
					'd2l.my-courses.root-enrollments.response'
				);

				if (!enrollmentsRootEntity.hasAction('search-my-enrollments')) {
					return Promise.resolve();
				}

				this._enrollmentsSearchUrl = this._createFetchEnrollmentsUrl(enrollmentsRootEntity)

				this.performanceMark('d2l.my-courses.search-enrollments.request');
				return this.fetchSirenEntity(this._enrollmentsSearchUrl)
					.then(this._populateEnrollments.bind(this));
			},
			_createFetchEnrollmentsUrl: function(enrollmentsRootEntity, bustCache) {
				var searchAction = enrollmentsRootEntity.getActionByName('search-my-enrollments');

				var query = {
					pageSize: 25,
					embedDepth: 1,
					sort: '-PinDate,OrgUnitName,OrgUnitId',
					autoPinCourses: true
				};
				var enrollmentsSearchUrl = this.createActionUrl(searchAction, query);
				if (bustCache) enrollmentsSearchUrl += '&bustCache=' + Math.random();

				return enrollmentsSearchUrl;
			},
			_refetchEnrollments: function(enrollmentsRootEntity) {

				this.performanceMark('my-courses.root-enrollments.response');
				this.performanceMeasure(
					'my-courses.root-enrollments',
					'my-courses.root-enrollments.request',
					'my-courses.root-enrollments.response'
				);

				if (!enrollmentsRootEntity.hasAction('search-my-enrollments')) {
					return Promise.resolve();
				}

				var enrollmentsSearchUrl = this._createFetchEnrollmentsUrl(enrollmentsRootEntity, true);

				this.performanceMark('d2l.my-courses..search-enrollments.request');
				return this.fetchSirenEntity(enrollmentsSearchUrl)
					.then(this._populateEnrollments.bind(this));
			},
			_populateEnrollments: function(enrollmentsEntity) {
				this.performanceMark('d2l.my-courses..search-enrollments.response');
				this.performanceMeasure(
					'd2l.my-courses.search-enrollments',
					'd2l.my-courses.search-enrollments.request',
					'd2l.my-courses.search-enrollments.response'
				);

				this._lastEnrollmentsSearchResponse = enrollmentsEntity;
				var enrollmentEntities = enrollmentsEntity.getSubEntitiesByClass('enrollment');
				var newPinnedEnrollments = [];
				var newUnpinnedEnrollments = [];

				enrollmentEntities.forEach(function(enrollment) {
					var enrollmentId = this.getEntityIdentifier(enrollment);

					if (enrollment.hasClass('pinned')) {
						if (!this._pinnedCoursesMap.hasOwnProperty(enrollmentId)) {
							newPinnedEnrollments.push(enrollment);
							this._pinnedCoursesMap[enrollmentId] = true;
						}
					} else {
						if (!this._unpinnedCoursesMap.hasOwnProperty(enrollmentId)) {
							newUnpinnedEnrollments.push(enrollment);
							this._unpinnedCoursesMap[enrollmentId] = true;
						}
					}

					// TODO: This should be parsed down to just orgUnitId
					var orgLink = enrollment.getLinkByRel(this.HypermediaRels.organization);
					var orgUnitId = (orgLink || {}).href;
					if (!this.orgUnitIdMap.hasOwnProperty(orgUnitId)) {
						this.orgUnitIdMap[orgUnitId] = enrollment;
					}
				}, this);

				this.pinnedEnrollments = this.pinnedEnrollments.concat(newPinnedEnrollments);
				this.unpinnedEnrollments = this.unpinnedEnrollments.concat(newUnpinnedEnrollments);

				var colNum = this._calcNumColumns(this._getAvailableWidth(Polymer.dom(this.root).node.host), this.pinnedEnrollments.length);
				this._tileSizes = (colNum === 2) ?
					{ mobile: { maxwidth: 767, size: 50 }, tablet: { maxwidth: 1243, size: 33 }, desktop: { size: 20 } } :
					{ mobile: { maxwidth: 767, size: 100 }, tablet: { maxwidth: 1243, size: 67 }, desktop: { size: 25 } };

				this.fire('recalculate-columns');
			},
			_moveEnrollmentToPinnedList: function(enrollment) {
				var enrollmentId, enrollmentEntity;

				if (typeof enrollment === 'string') {
					enrollmentId = enrollment;
				} else {
					enrollmentEntity = enrollment;
					enrollmentId = this.getEntityIdentifier(enrollmentEntity);
				}

				for (var index = 0; index < this.unpinnedEnrollments.length; index++) {
					var pinnedEnrollmentId = this.getEntityIdentifier(this.unpinnedEnrollments[index]);
					if (pinnedEnrollmentId === enrollmentId) {
						enrollmentEntity = enrollmentEntity || this.unpinnedEnrollments[index];
						this.splice('unpinnedEnrollments', index, 1);
						break;
					}
				}

				if (enrollmentEntity) {
					this._addEnrollmentToList(true, enrollmentEntity);
				}
			},
			_moveEnrollmentToUnpinnedList: function(enrollment) {
				var enrollmentId, enrollmentEntity;

				if (typeof enrollment === 'string') {
					enrollmentId = enrollment;
				} else {
					enrollmentEntity = enrollment;
					enrollmentId = this.getEntityIdentifier(enrollmentEntity);
				}

				for (var index = 0; index < this.pinnedEnrollments.length; index++) {
					var unpinnedEnrollmentId = this.getEntityIdentifier(this.pinnedEnrollments[index]);
					if (unpinnedEnrollmentId === enrollmentId) {
						enrollmentEntity = enrollmentEntity || this.pinnedEnrollments[index];
						this.splice('pinnedEnrollments', index, 1);
						break;
					}
				}

				if (enrollmentEntity) {
					this._addEnrollmentToList(false, enrollmentEntity);
				}
			},
			_openAllCoursesView: function(e) {
				this._createAllCourses();

				var allCourses = this.$$('d2l-all-courses');
				allCourses.open();

				e.preventDefault();
				e.stopPropagation();

				this.async(function() {
					// The opening of the overlay lags slightly if we try to do this while it
					// is opening - do it after the animation is finished. Animation takes
					// 500ms, but some lag if we wait exactly that long, so +100ms for safety)
					allCourses.pinnedEnrollments = this.pinnedEnrollments;
					allCourses.unpinnedEnrollments = this.unpinnedEnrollments;
					allCourses.myEnrollmentsEntity = this._lastEnrollmentsSearchResponse;
					allCourses.lastEnrollmentsSearchResponse = this._lastEnrollmentsSearchResponse;
					allCourses.locale = this.locale;
					allCourses.showCourseCode = this.showCourseCode;
					allCourses.showSemester = this.showSemester;
					allCourses.advancedSearchUrl = this.advancedSearchUrl;
					allCourses.filterStandardSemesterName = this.standardSemesterName;
					allCourses.filterStandardDepartmentName = this.standardDepartmentName;
					allCourses.courseUpdatesConfig = this.courseUpdatesConfig;
					allCourses.telemetryEndpoint = this.telemetryEndpoint;
					allCourses.userId = this.userId;
					allCourses.tenantId = this.tenantId;

					this.$$('d2l-all-courses').load();
				}.bind(this), 600);
			},
			_refreshPage: function() {
				document.location.reload(true);
			},
			_getOrgUnitId: function(organization) {
				var match = /[0-9]+$/.exec(this.getEntityIdentifier(organization));

				if (!match) {
					return;
				}
				return match[0];
			}
		});
	</script>
</dom-module>
