<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
		<script src="../../../webcomponentsjs/webcomponents-lite.js"></script>
		<script src="../../../web-component-tester/browser.js"></script>
		<script src="https://s.brightspace.com/lib/d2lfetch/1.2.0/d2lfetch.js"></script>

		<link rel="import" href="../../src/d2l-all-courses-unified-content.html">
	</head>
	<body>
		<test-fixture id="d2l-all-courses-unified-content-fixture">
			<template>
				<d2l-all-courses-unified-content
					use-saved-searches="true"
					filtered-enrollments='[]'>
				</d2l-all-courses-unified-content>
			</template>
		</test-fixture>

		<test-fixture id="event-test-fixture">
			<template>
				<div id="foo">
					<div>
						<d2l-all-courses-unified-content
							use-saved-searches="true"
							filtered-enrollments='[]'>
						</d2l-all-courses-unified-content>
					</div>
				</div>
			</template>
		</test-fixture>

		<script>
		describe('d2l-all-courses-unified-content', function() {
			var widget, sandbox;

			beforeEach(function(done) {
				sandbox = sinon.sandbox.create();
				widget = fixture('d2l-all-courses-unified-content-fixture');

				setTimeout(function() {
					done();
				});
			});

			afterEach(function() {
				sandbox.restore();
			});

			describe('changing enrollment entities', function() {
				[
					{ isSearched: true, totalFilterCount: 0, enrollmentsChanged: 0, noCoursesInSearch: true, noCoursesInSelection: false },
					{ isSearched: true, totalFilterCount: 0, enrollmentsChanged: 3, noCoursesInSearch: false, noCoursesInSelection: false },
					{ isSearched: false, totalFilterCount: 2, enrollmentsChanged: 0, noCoursesInSearch: false, noCoursesInSelection: true }
				].forEach(testCase => {
					it(`should set noCoursesInSearch to ${testCase.noCoursesInSearch} and noCoursesInSelection to ${testCase.noCoursesInSelection} when enrollments change to ${testCase.enrollmentsChanged}, isSearched is ${testCase.isSearched} and totalFilterCount is ${testCase.totalFilterCount}`, () => {
						widget.isSearched = testCase.isSearched;
						widget.totalFilterCount = testCase.totalFilterCount;
						widget._enrollmentsChanged(testCase.enrollmentsChanged);
						expect(widget._noCoursesInSearch).to.equal(testCase.noCoursesInSearch);
						expect(widget._noCoursesInSelection).to.equal(testCase.noCoursesInSelection);
					});
				});

				[
					{ isSearched: false, totalFilterCount: 0, enrollmentsChanged: 3, itemCount: 3 },
					{ isSearched: true, totalFilterCount: 0, enrollmentsChanged: 2, itemCount: 0 },
					{ isSearched: false, totalFilterCount: 1, enrollmentsChanged: 2, itemCount: 0 }
				].forEach(testCase => {
					it(`should set itemCount to ${testCase.itemCount} when enrollments change to ${testCase.enrollmentsChanged}, isSearched is ${testCase.isSearched} and totalFilterCount is ${testCase.totalFilterCount}`, () => {
						widget.isSearched = testCase.isSearched;
						widget.totalFilterCount = testCase.totalFilterCount;
						widget._enrollmentsChanged(testCase.enrollmentsChanged);
						expect(widget._itemCount).to.equal(testCase.itemCount);
					});
				});
			});

			describe('filtering when there are no courses', () => {
				[
					{ target: '_noCoursesInDepartment', filter: 'departments' },
					{ target: '_noCoursesInSemester', filter: 'semesters' },
					{ target: '_noCoursesInRole', filter: 'roles' }
				].forEach(testCase => {
					it(`should set ${testCase.target} when there are no enrollments and one ${testCase.filter} is filtered`, () => {
						widget.isSearched = false;
						widget.totalFilterCount = 1;
						widget.filterCounts = {};
						widget.filterCounts[testCase.filter] = 1;
						widget._enrollmentsChanged(0);
						expect(widget[testCase.target]).to.be.true;
					});
				});

				[
					{ target: '_noCoursesInDepartment', filter: 'departments' },
					{ target: '_noCoursesInSemester', filter: 'semesters' },
					{ target: '_noCoursesInRole', filter: 'roles' }
				].forEach(testCase => {
					it(`should not set ${testCase.target} when there are no enrollments and more than one ${testCase.filter} are filtered`, () => {
						widget.isSearched = false;
						widget.totalFilterCount = 1;
						widget.filterCounts = {};
						widget.filterCounts[testCase.filter] = 3;
						widget._enrollmentsChanged(0);
						expect(widget[testCase.target]).to.be.false;
					});
				});

				it('should not set empty filter messages when there are more than one filters', () => {
					widget.isSearched = false;
					widget.totalFilterCount = 4;
					widget.filterCounts = {};
					widget._enrollmentsChanged(0);
					expect(widget._noCoursesInDepartment).to.be.false;
					expect(widget._noCoursesInSemester).to.be.false;
					expect(widget._noCoursesInRole).to.be.false;
				});
			});
		});
</script>
	</body>
</html>
